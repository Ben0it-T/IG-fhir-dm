# üè• Infrastructure Docker PostgreSQL EHR avec Support Fran√ßais

Infrastructure PostgreSQL conteneuris√©e optimis√©e pour les donn√©es de sant√© FHIR avec support complet du fran√ßais.

## üá´üá∑ Fonctionnalit√©s Principales

‚úÖ **PostgreSQL 16** avec optimisations pour donn√©es de sant√©  
‚úÖ **Support fran√ßais complet**: UTF-8, collation fran√ßaise, locale fr_FR  
‚úÖ **Caract√®res accentu√©s**: √©, √®, √™, √´, √†, √ß, √π, ≈ì, etc.  
‚úÖ **Tri alphab√©tique fran√ßais** avec collation appropri√©e  
‚úÖ **Recherche textuelle fran√ßaise** avec configuration `french`  
‚úÖ **Initialisation automatique** du sch√©ma EHR  
‚úÖ **Volumes persistants** pour donn√©es et logs  
‚úÖ **Healthcheck int√©gr√©** et monitoring  
‚úÖ **Interface pgAdmin** optionnelle  

## üìÅ Structure des Fichiers

```
data-plateform/raw-layer/docker/
‚îú‚îÄ‚îÄ docker-compose.yml          # Configuration Docker Compose
‚îú‚îÄ‚îÄ init/                       # Scripts d'initialisation SQL
‚îÇ   ‚îú‚îÄ‚îÄ 01-create-database.sql  # Cr√©ation de la base de donn√©es
‚îÇ   ‚îî‚îÄ‚îÄ 02-create-tables.sql    # Cr√©ation du sch√©ma EHR
‚îú‚îÄ‚îÄ .env                        # Variables d'environnement (√† cr√©er)
‚îú‚îÄ‚îÄ .env.example               # Template de configuration
‚îî‚îÄ‚îÄ README.md                  # Cette documentation
```

## üöÄ Installation et D√©marrage

### Pr√©requis

- Docker Engine 20.10+
- Docker Compose V2
- 2GB RAM disponible minimum
- 10GB espace disque libre

### 1. Configuration

```bash
# Copier le template de configuration
cp .env.example .env

# √âditer les variables d'environnement
nano .env

# IMPORTANT: Changer les mots de passe par d√©faut !
```

### 2. D√©marrage de l'infrastructure

```bash
# D√©marrage PostgreSQL seul
docker-compose up -d

# D√©marrage avec pgAdmin (optionnel)
docker-compose --profile admin up -d

# D√©marrage en mode d√©veloppement complet
docker-compose --profile full up -d
```

### 3. V√©rification du d√©marrage

```bash
# V√©rifier l'√©tat des services
docker-compose ps

# Voir les logs PostgreSQL
docker-compose logs postgres_ehr

# V√©rifier la sant√© de PostgreSQL
docker-compose exec postgres_ehr pg_isready -U ehr_user -d ehr
```

## üîß Configuration

### Variables d'Environnement (.env)

```bash
# Base de donn√©es
POSTGRES_DB=ehr
POSTGRES_USER=ehr_user
POSTGRES_PASSWORD=votre_mot_de_passe_s√©curis√©

# R√©seau
POSTGRES_HOST=localhost
POSTGRES_PORT=5433

# pgAdmin (optionnel)
PGADMIN_EMAIL=admin@ehr.local
PGADMIN_PASSWORD=admin_mot_de_passe_s√©curis√©
PGADMIN_PORT=8080
```

### Configuration Fran√ßaise Automatique

L'infrastructure configure automatiquement :

```sql
-- Encodage et locale
ENCODING = 'UTF8'
LC_COLLATE = 'fr_FR.UTF-8'
LC_CTYPE = 'fr_FR.UTF-8'
LC_MESSAGES = 'fr_FR.UTF-8'
LC_MONETARY = 'fr_FR.UTF-8'
LC_NUMERIC = 'fr_FR.UTF-8'
LC_TIME = 'fr_FR.UTF-8'

-- Recherche textuelle fran√ßaise
default_text_search_config = 'french'
```

## üèóÔ∏è Sch√©ma de Base de Donn√©es

### Tables Cr√©√©es Automatiquement

1. **`patient`** - Informations d√©mographiques patients
2. **`patient_adresse`** - Adresses et g√©ocodage
3. **`donnees_pmsi`** - Donn√©es d'hospitalisation PMSI
4. **`diagnostics`** - Codes diagnostiques (ICD-10)
5. **`actes`** - Actes m√©dicaux (CCAM)
6. **`biologie`** - R√©sultats de laboratoire (LOINC)
7. **`prescription`** - Prescriptions m√©dicamenteuses (ATC)
8. **`posologie`** - Informations de dosage
9. **`administration`** - Administration de m√©dicaments
10. **`dossier_soins`** - Dossier de soins et mesures
11. **`style_vie`** - Facteurs de style de vie

### Optimisations PostgreSQL 16

- **Index hash** pour recherches exactes
- **Index couvrants** avec colonnes INCLUDE
- **Index spatiaux GIST** pour g√©ocodage
- **Recherche textuelle** avec support fran√ßais
- **Contraintes de validation** compl√®tes

## üíæ Connexion √† la Base de Donn√©es

### Via Client PostgreSQL

```bash
# Connexion depuis l'h√¥te
psql -h localhost -p 5433 -U ehr_user -d ehr

# Connexion depuis un autre conteneur
psql -h postgres_ehr -p 5432 -U ehr_user -d ehr
```

### Via pgAdmin

1. Acc√©der √† http://localhost:8080
2. Se connecter avec les identifiants configur√©s dans `.env`
3. Ajouter un serveur :
   - Nom: EHR PostgreSQL
   - H√¥te: postgres_ehr
   - Port: 5432
   - Base: ehr
   - Utilisateur/Mot de passe: depuis `.env`

### Via Python (psycopg2)

```python
import psycopg2

# Configuration de connexion
conn_params = {
    'host': 'localhost',
    'port': 5433,
    'database': 'ehr',
    'user': 'ehr_user',
    'password': 'votre_mot_de_passe',
    'client_encoding': 'UTF8'
}

# Connexion avec support fran√ßais
conn = psycopg2.connect(**conn_params)
conn.set_client_encoding('UTF8')
```

## üìä Import de Donn√©es CSV Fran√ßaises

### Utilisation du Loader Python

```bash
# Aller dans le r√©pertoire du loader
cd ../test/loader

# Installer les d√©pendances
pip install -r requirements.txt

# Charger les donn√©es de test avec d√©tection d'encodage
python load_test_patients.py \
    --database ehr \
    --user ehr_user \
    --password votre_mot_de_passe \
    --host localhost \
    --port 5433 \
    --clear
```

### Import Manuel avec Caract√®res Fran√ßais

```sql
-- D√©finir l'encodage pour la session
SET client_encoding = 'UTF8';

-- Import avec COPY pour performance optimale
COPY patient(nom, prenom, sexe, date_naissance) 
FROM '/path/to/patients.csv' 
WITH (FORMAT CSV, HEADER true, ENCODING 'UTF8');

-- V√©rifier l'import des caract√®res fran√ßais
SELECT nom, prenom 
FROM patient 
WHERE nom ~ '[√©√®√™√´√†√¢√§√ß√Æ√Ø√¥√∂√π√ª√º√ø√±]'
ORDER BY nom COLLATE "fr_FR";
```

## üîç Requ√™tes avec Support Fran√ßais

### Recherche Textuelle Fran√ßaise

```sql
-- Recherche insensible aux accents
SELECT nom, prenom 
FROM patient 
WHERE to_tsvector('french', nom || ' ' || prenom) @@ to_tsquery('french', 'francois');

-- Fonction de nettoyage des accents
SELECT clean_french_text('Fran√ßois-Jos√© M√ºller');
-- R√©sultat: 'francois-jose muller'
```

### Tri Alphab√©tique Fran√ßais

```sql
-- Tri correct avec collation fran√ßaise
SELECT nom, prenom 
FROM patient 
ORDER BY nom COLLATE "fr_FR.UTF-8", prenom COLLATE "fr_FR.UTF-8";

-- Tri avec caract√®res sp√©ciaux
SELECT * FROM patient 
WHERE nom LIKE '%√ß%' OR nom LIKE '%√©%'
ORDER BY nom COLLATE "fr_FR";
```

### Requ√™tes avec Dates Fran√ßaises

```sql
-- Affichage de dates en fran√ßais
SELECT 
    nom,
    prenom,
    to_char(date_naissance, 'DD TMMonth YYYY', 'lc_time=fr_FR.UTF-8') as date_naissance_fr
FROM patient
ORDER BY date_naissance DESC;
```

## üõ†Ô∏è Gestion des Probl√®mes d'Encodage

### Probl√®mes Courants et Solutions

#### 1. Caract√®res Affich√©s Incorrectement

```bash
# V√©rifier l'encodage de la base
docker-compose exec postgres_ehr psql -U ehr_user -d ehr -c "SHOW server_encoding;"

# V√©rifier la locale
docker-compose exec postgres_ehr locale
```

#### 2. Erreurs d'Import CSV

```sql
-- D√©tecter l'encodage d'un fichier
\! file -i /path/to/file.csv

-- Import avec encodage sp√©cifique
COPY table_name FROM '/path/to/file.csv' 
WITH (FORMAT CSV, ENCODING 'LATIN1');
```

#### 3. Tri Incorrect des Caract√®res Fran√ßais

```sql
-- V√©rifier la collation
SELECT datname, datcollate, datctype 
FROM pg_database 
WHERE datname = 'ehr';

-- Forcer la collation fran√ßaise
SELECT * FROM table_name ORDER BY column_name COLLATE "fr_FR.UTF-8";
```

## üìà Monitoring et Maintenance

### V√©rification de l'√âtat

```bash
# Sant√© des conteneurs
docker-compose ps
docker-compose exec postgres_ehr pg_isready

# Statistiques de performance
docker stats ehr_postgres_db

# Espace disque utilis√©
docker-compose exec postgres_ehr du -sh /var/lib/postgresql/data
```

### Logs et Diagnostics

```bash
# Logs PostgreSQL
docker-compose logs -f postgres_ehr

# Logs avec timestamp
docker-compose logs -f --timestamps postgres_ehr

# Logs d'erreurs uniquement
docker-compose logs postgres_ehr 2>&1 | grep ERROR
```

### Sauvegarde et Restauration

```bash
# Sauvegarde compl√®te
docker-compose exec postgres_ehr pg_dump -U ehr_user -d ehr > backup_ehr.sql

# Sauvegarde avec compression
docker-compose exec postgres_ehr pg_dump -U ehr_user -d ehr | gzip > backup_ehr.sql.gz

# Restauration
docker-compose exec -T postgres_ehr psql -U ehr_user -d ehr < backup_ehr.sql
```

## üîí S√©curit√©

### Recommandations de Production

1. **Mots de passe forts** (12+ caract√®res, mixte)
2. **SSL/TLS** activ√© pour connexions externes
3. **Pare-feu** limitant l'acc√®s au port 5433
4. **Sauvegrades r√©guli√®res** automatis√©es
5. **Monitoring** des connexions et performances

### Configuration SSL/TLS

```yaml
# Ajout dans docker-compose.yml
environment:
  - POSTGRES_INITDB_ARGS=--auth-host=md5 --auth-local=md5
  - POSTGRES_HOST_AUTH_METHOD=md5
volumes:
  - ./ssl/server.crt:/var/lib/postgresql/server.crt:ro
  - ./ssl/server.key:/var/lib/postgresql/server.key:ro
command: >
  postgres
  -c ssl=on
  -c ssl_cert_file=/var/lib/postgresql/server.crt
  -c ssl_key_file=/var/lib/postgresql/server.key
```

## üß™ Tests et Validation

### Test de Configuration Fran√ßaise

```sql
-- Test des caract√®res fran√ßais
SELECT check_french_encoding();

-- Test du tri fran√ßais
CREATE TEMP TABLE test_tri AS 
SELECT unnest(ARRAY['Andr√©', '√âmile', 'Zo√©', '√âlise']) as nom;

SELECT nom FROM test_tri ORDER BY nom COLLATE "fr_FR.UTF-8";
```

### Test de Performance

```sql
-- Statistiques d'index
SELECT schemaname, tablename, indexname, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes 
WHERE schemaname = 'public'
ORDER BY idx_tup_read DESC;

-- Performance des requ√™tes
SELECT query, mean_time, calls 
FROM pg_stat_statements 
WHERE query LIKE '%patient%'
ORDER BY mean_time DESC;
```

## üìû Support et D√©pannage

### Commandes Utiles

```bash
# Red√©marrer PostgreSQL seul
docker-compose restart postgres_ehr

# R√©initialiser compl√®tement (‚ö†Ô∏è PERTE DE DONN√âES)
docker-compose down -v
docker-compose up -d

# Acc√®s shell au conteneur
docker-compose exec postgres_ehr bash

# Connexion psql directe
docker-compose exec postgres_ehr psql -U ehr_user -d ehr
```

### FAQ

**Q: Comment changer le mot de passe PostgreSQL ?**
```sql
ALTER USER ehr_user PASSWORD 'nouveau_mot_de_passe';
```

**Q: Comment augmenter les performances ?**
```bash
# Ajuster les param√®tres dans .env
POSTGRES_SHARED_BUFFERS=512MB
POSTGRES_EFFECTIVE_CACHE_SIZE=2GB
```

**Q: Comment activer les logs de requ√™tes lentes ?**
```bash
# Dans docker-compose.yml
-c log_min_duration_statement=500
```

## üîÑ Mise √† Jour

### Mise √† Jour de PostgreSQL

```bash
# Sauvegarder avant mise √† jour
docker-compose exec postgres_ehr pg_dumpall -U ehr_user > backup_full.sql

# Mettre √† jour l'image
docker-compose pull postgres_ehr
docker-compose up -d postgres_ehr
```

### Mise √† Jour du Sch√©ma

```bash
# Appliquer les migrations
docker-compose exec postgres_ehr psql -U ehr_user -d ehr -f /docker-entrypoint-initdb.d/migration.sql
```

## üìÑ Licence et Contribution

Ce projet est con√ßu pour les donn√©es de sant√© FHIR avec support fran√ßais optimal.

**√âquipe de maintenance**: EHR Team  
**Version**: 1.0.0  
**Support fran√ßais**: Complet (UTF-8, fr_FR.UTF-8)  

---

üá´üá∑ **Infrastructure PostgreSQL pr√™te pour donn√©es de sant√© fran√ßaises avec support FHIR complet !**