version: 2

models:
  - name: stg_ehr__patient
    description: "Staging model for patient demographic and identification data from EHR system"
    columns:
      - name: patient_id
        description: "Original patient identifier from EHR"
        tests:
          - unique
          - not_null
      - name: fhir_patient_id
        description: "FHIR-formatted patient resource ID"
        tests:
          - unique
      - name: family_name
        description: "Standardized family name (uppercase)"
      - name: given_name
        description: "Standardized given name (title case)"
      - name: nir
        description: "French National Insurance Number (NIR)"
      - name: ins
        description: "French National Health Insurance identifier"
      - name: birth_date
        description: "Patient birth date"
        tests:
          - not_null
      - name: gender
        description: "Standardized gender (male/female/unknown)"
        tests:
          - accepted_values:
              values: ['male', 'female', 'unknown']
      - name: has_valid_nir
        description: "Data quality flag: TRUE if NIR has valid format (13 digits)"
      - name: has_ins
        description: "Data quality flag: TRUE if INS identifier is present"
      - name: has_location
        description: "Data quality flag: TRUE if geographic coordinates are available"

  - name: stg_ehr__donnees_pmsi
    description: "Staging model for hospital encounter data from PMSI system"
    columns:
      - name: pmsi_id
        description: "Original PMSI episode identifier"
        tests:
          - unique
          - not_null
      - name: fhir_encounter_id
        description: "FHIR-formatted encounter resource ID"
        tests:
          - unique
      - name: fhir_patient_id
        description: "Reference to FHIR patient resource"
        tests:
          - not_null
      - name: encounter_status
        description: "FHIR encounter status (planned/in-progress/finished)"
        tests:
          - accepted_values:
              values: ['planned', 'in-progress', 'finished']
      - name: encounter_class
        description: "FHIR encounter class code (IMP/AMB/EMER)"
        tests:
          - accepted_values:
              values: ['IMP', 'AMB', 'EMER']
      - name: admission_datetime
        description: "Hospital admission timestamp"
        tests:
          - not_null
      - name: length_of_stay_days
        description: "Length of stay in days"

  - name: stg_ehr__diagnostics
    description: "Staging model for diagnostic codes and conditions"
    columns:
      - name: diagnostic_id
        description: "Original diagnostic record identifier"
        tests:
          - unique
          - not_null
      - name: fhir_condition_id
        description: "FHIR-formatted condition resource ID"
        tests:
          - unique
      - name: fhir_encounter_id
        description: "Reference to FHIR encounter resource"
        tests:
          - not_null
      - name: icd10_code
        description: "Standardized ICD-10 diagnostic code"
      - name: condition_category
        description: "FHIR condition category"
        tests:
          - accepted_values:
              values: ['encounter-diagnosis', 'problem-list-item']
      - name: verification_status
        description: "FHIR verification status"
        tests:
          - accepted_values:
              values: ['confirmed', 'provisional']
      - name: clinical_status
        description: "FHIR clinical status"
        tests:
          - accepted_values:
              values: ['active', 'inactive', 'resolved']

  - name: stg_ehr__actes
    description: "Staging model for medical procedures and interventions"
    columns:
      - name: acte_id
        description: "Original procedure record identifier"
        tests:
          - unique
          - not_null
      - name: fhir_procedure_id
        description: "FHIR-formatted procedure resource ID"
        tests:
          - unique
      - name: fhir_encounter_id
        description: "Reference to FHIR encounter resource"
        tests:
          - not_null
      - name: ccam_code
        description: "French CCAM procedure code"
      - name: procedure_status
        description: "FHIR procedure status"
        tests:
          - accepted_values:
              values: ['completed', 'in-progress', 'not-done']
      - name: procedure_category
        description: "FHIR procedure category based on CCAM classification"
        tests:
          - accepted_values:
              values: ['surgical', 'therapeutic', 'diagnostic']

  - name: stg_ehr__biologie
    description: "Staging model for laboratory test results"
    columns:
      - name: biologie_id
        description: "Original laboratory test identifier"
        tests:
          - unique
          - not_null
      - name: fhir_observation_id
        description: "FHIR-formatted observation resource ID"
        tests:
          - unique
      - name: fhir_patient_id
        description: "Reference to FHIR patient resource"
        tests:
          - not_null
      - name: loinc_code
        description: "LOINC code for laboratory test"
      - name: observation_status
        description: "FHIR observation status"
        tests:
          - accepted_values:
              values: ['final', 'preliminary', 'amended']
      - name: observation_category
        description: "FHIR observation category"
        tests:
          - accepted_values:
              values: ['laboratory']
      - name: value_type
        description: "Type of observation value (Quantity/string)"
        tests:
          - accepted_values:
              values: ['Quantity', 'string']

  - name: stg_ehr__exposition_medicamenteuse
    description: "Staging model for medication exposures and prescriptions"
    columns:
      - name: exposition_id
        description: "Original medication exposure identifier"
        tests:
          - unique
          - not_null
      - name: fhir_medication_request_id
        description: "FHIR-formatted medication request resource ID"
        tests:
          - unique
      - name: fhir_patient_id
        description: "Reference to FHIR patient resource"
        tests:
          - not_null
      - name: atc_code
        description: "ATC medication classification code"
      - name: medication_request_status
        description: "FHIR medication request status"
        tests:
          - accepted_values:
              values: ['active', 'completed', 'cancelled']
      - name: medication_request_intent
        description: "FHIR medication request intent"
        tests:
          - accepted_values:
              values: ['order', 'plan', 'proposal']

  - name: stg_ehr__dossier_soins
    description: "Staging model for vital signs and nursing observations"
    columns:
      - name: soins_id
        description: "Original nursing care record identifier"
        tests:
          - not_null
          - relationships:
              to: ref('dossier_soins_sample')
              field: soins_id
      - name: fhir_observation_id
        description: "FHIR-formatted observation resource ID"
        tests:
          - unique
          - not_null
      - name: fhir_patient_id
        description: "Reference to FHIR patient resource"
        tests:
          - not_null
      - name: loinc_code
        description: "LOINC code for vital sign measurement"
      - name: observation_category
        description: "FHIR observation category"
        tests:
          - accepted_values:
              values: ['vital-signs']
      - name: numeric_value
        description: "Numeric value for quantitative measurements"

  - name: stg_ehr__style_vie
    description: "Staging model for lifestyle factors and social determinants"
    columns:
      - name: style_vie_id
        description: "Original lifestyle record identifier"
        tests:
          - not_null
          - relationships:
              to: ref('style_vie_sample')
              field: style_vie_id
      - name: fhir_observation_id
        description: "FHIR-formatted observation resource ID"
        tests:
          - unique
          - not_null
      - name: fhir_patient_id
        description: "Reference to FHIR patient resource"
        tests:
          - not_null
      - name: loinc_code
        description: "LOINC code for lifestyle factor"
      - name: observation_category
        description: "FHIR observation category"
        tests:
          - accepted_values:
              values: ['social-history']
      - name: value_type
        description: "Type of lifestyle value (Quantity/boolean/string)"
        tests:
          - accepted_values:
              values: ['Quantity', 'boolean', 'string']