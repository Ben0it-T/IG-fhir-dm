version: 2

models:
  - name: stg_ehr__patient
    description: >
      Staging model for patient demographics and identity information.
      Source-conformed with basic data type casting and standardization.
    columns:
      - name: patient_id
        description: "Unique patient identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: family_name
        description: "Standardized family name"
      - name: given_name
        description: "Standardized given name"
      - name: ins_nir_identifier
        description: "Clean INS-NIR identifier (13 digits)"
      - name: ins_identifier
        description: "Clean INS identifier"
      - name: birth_date
        description: "Birth date (standardized)"
        tests:
          - not_null
      - name: gender_code
        description: "Standardized gender code (M/F/U)"
        tests:
          - accepted_values:
              values: ['M', 'F', 'U']
      - name: deceased_date
        description: "Death date if applicable"
      - name: deceased_source
        description: "Source of death information"
      - name: multiple_birth_rank
        description: "Multiple birth rank"
      - name: address_latitude
        description: "Residence latitude"
      - name: address_longitude
        description: "Residence longitude"
      - name: address_iris_code
        description: "IRIS geographic code"
      - name: address_iris_label
        description: "IRIS geographic label"
      - name: address_postal_code
        description: "Postal code"
      - name: address_city
        description: "City name"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__encounter
    description: >
      Staging model for healthcare encounters from PMSI data.
      Source-conformed with period calculations and status standardization.
    columns:
      - name: encounter_id
        description: "Unique encounter identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: patient_id
        description: "Patient reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__patient')
              field: patient_id
      - name: encounter_status
        description: "Standardized encounter status"
      - name: encounter_class
        description: "Encounter class (inpatient/outpatient/etc)"
      - name: period_start
        description: "Encounter start date/time"
      - name: period_end
        description: "Encounter end date/time"
      - name: length_of_stay_days
        description: "Length of stay in days"
      - name: admission_mode
        description: "Mode of admission"
      - name: discharge_mode
        description: "Mode of discharge"
      - name: administrative_status
        description: "Administrative status"
      - name: facility_name
        description: "Healthcare facility"
      - name: functional_unit
        description: "Functional unit"
      - name: clinical_service
        description: "Clinical service/ward"
      - name: residence_code
        description: "Patient residence code at encounter time"
      - name: residence_label
        description: "Patient residence label at encounter time"
      - name: data_collection_date
        description: "Data collection date"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__condition
    description: >
      Staging model for diagnostic conditions.
      Source-conformed with ICD-10 code validation and categorization.
    columns:
      - name: condition_id
        description: "Unique condition identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: encounter_id
        description: "Encounter reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__encounter')
              field: encounter_id
      - name: icd10_code
        description: "ICD-10 diagnostic code"
        tests:
          - not_null
      - name: condition_text
        description: "Condition description"
      - name: diagnosis_type
        description: "Type of diagnosis (primary, secondary, etc.)"
      - name: diagnosis_date
        description: "Diagnosis date"
      - name: diagnosis_sequence
        description: "Diagnosis sequence number"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__procedure
    description: >
      Staging model for medical procedures and acts.
      Source-conformed with CCAM code validation and performer information.
    columns:
      - name: procedure_id
        description: "Unique procedure identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: encounter_id
        description: "Encounter reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__encounter')
              field: encounter_id
      - name: ccam_code
        description: "CCAM procedure code"
        tests:
          - not_null
      - name: procedure_text
        description: "Procedure description"
      - name: performed_datetime
        description: "Procedure date/time"
      - name: performer_name
        description: "Procedure performer"
      - name: procedure_sequence
        description: "Procedure sequence number"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__laboratory
    description: >
      Staging model for laboratory test results.
      Source-conformed with value standardization and reference ranges.
    columns:
      - name: laboratory_id
        description: "Unique laboratory result identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: encounter_id
        description: "Encounter reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__encounter')
              field: encounter_id
      - name: patient_id
        description: "Patient reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__patient')
              field: patient_id
      - name: loinc_code
        description: "LOINC code for test"
      - name: test_name
        description: "Test name/label"
      - name: test_category
        description: "Test category (laboratory type)"
      - name: numeric_value
        description: "Numeric result value"
      - name: text_value
        description: "Text result value"
      - name: unit_of_measure
        description: "Unit of measurement"
      - name: collection_datetime
        description: "Sample collection date/time"
      - name: validation_status
        description: "Result validation status"
      - name: reference_range_low
        description: "Lower reference range"
      - name: reference_range_high
        description: "Upper reference range"
      - name: laboratory_name
        description: "Performing laboratory"
      - name: analysis_method
        description: "Analysis method"
      - name: result_comment
        description: "Result comments"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__medication_exposure
    description: >
      Staging model for medication exposures and prescriptions.
      Source-conformed with ATC code validation and administration details.
    columns:
      - name: medication_exposure_id
        description: "Unique medication exposure identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: encounter_id
        description: "Encounter reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__encounter')
              field: encounter_id
      - name: patient_id
        description: "Patient reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__patient')
              field: patient_id
      - name: atc_code
        description: "ATC medication code"
      - name: medication_name
        description: "Medication denomination"
      - name: pharmaceutical_form
        description: "Pharmaceutical form"
      - name: administration_route
        description: "Route of administration"
      - name: prescription_type
        description: "Type of prescription"
      - name: prescriber_name
        description: "Prescriber name"
      - name: start_date
        description: "Medication start date"
      - name: end_date
        description: "Medication end date"
      - name: prescription_date
        description: "Prescription date"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__vital_signs
    description: >
      Staging model for vital signs and physical measurements.
      Source-conformed with measurement validation and units standardization.
    columns:
      - name: vital_signs_id
        description: "Unique vital signs record identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: encounter_id
        description: "Encounter reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__encounter')
              field: encounter_id
      - name: patient_id
        description: "Patient reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__patient')
              field: patient_id
      - name: height_cm
        description: "Height in centimeters"
      - name: height_measurement_date
        description: "Height measurement date"
      - name: weight_kg
        description: "Weight in kilograms"
      - name: weight_measurement_date
        description: "Weight measurement date"
      - name: systolic_bp_mmhg
        description: "Systolic blood pressure in mmHg"
      - name: systolic_bp_measurement_date
        description: "Systolic BP measurement date"
      - name: diastolic_bp_mmhg
        description: "Diastolic blood pressure in mmHg"
      - name: diastolic_bp_measurement_date
        description: "Diastolic BP measurement date"
      - name: measurement_type
        description: "Type of measurement"
      - name: care_unit
        description: "Care unit where measured"
      - name: healthcare_professional
        description: "Healthcare professional name"
      - name: measurement_comment
        description: "Measurement comments"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__lifestyle
    description: >
      Staging model for lifestyle observations and social history.
      Source-conformed with standardized lifestyle categories.
    columns:
      - name: lifestyle_id
        description: "Unique lifestyle record identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: encounter_id
        description: "Encounter reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__encounter')
              field: encounter_id
      - name: patient_id
        description: "Patient reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__patient')
              field: patient_id
      - name: tobacco_use
        description: "Tobacco consumption status"
      - name: alcohol_use
        description: "Alcohol consumption status"
      - name: substance_use
        description: "Other substance use status"
      - name: physical_activity
        description: "Physical activity level"
      - name: data_collection_date
        description: "Data collection date"
      - name: last_updated
        description: "Last update timestamp"

  - name: stg_ehr__dosing
    description: >
      Staging model for medication dosing information.
      Source-conformed with dose calculations and administration timing.
    columns:
      - name: dosing_id
        description: "Unique dosing record identifier - surrogate key"
        tests:
          - not_null
          - unique
      - name: medication_exposure_id
        description: "Medication exposure reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__medication_exposure')
              field: medication_exposure_id
      - name: patient_id
        description: "Patient reference"
        tests:
          - not_null
          - relationships:
              to: ref('stg_ehr__patient')
              field: patient_id
      - name: dosing_start_date
        description: "Dosing start date"
      - name: dosing_end_date
        description: "Dosing end date"
      - name: doses_per_day
        description: "Number of doses per day"
      - name: administered_quantity
        description: "Administered quantity"
      - name: quantity_unit
        description: "Quantity unit"
      - name: administration_start_datetime
        description: "Administration start date/time"
      - name: administration_end_datetime
        description: "Administration end date/time"
      - name: last_updated
        description: "Last update timestamp"