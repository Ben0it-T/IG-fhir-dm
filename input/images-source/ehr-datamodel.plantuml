@startuml ehr-datamodel

skinparam Shadowing 1.0
' avoid problems with angled crows feet
skinparam linetype ortho

scale max 1100 width

title
Modèle de donnée du DPI
end title

' Entity styling
!define TABLE(name) entity name
!define PK(field) <b><u>field</u></b>
!define FK(field) <i>field</i>

' =====================================================
' CORE PATIENT AND ENCOUNTER DATA
' =====================================================

TABLE(patient) {
  PK(patient_id) : BIGSERIAL
  --
  ' Identity fields (linkId: 2958000860428)
  nom : VARCHAR(255)
  prenom : VARCHAR(255)
  nir : VARCHAR(15)
  ins : VARCHAR(50)
  date_naissance : DATE
  sexe : VARCHAR(20)
  date_deces : DATE
  source_deces : VARCHAR(50)
  rang_gemellaire : INTEGER
  --
  ' Geocoding fields (linkId: 3816475533472)
  latitude : DECIMAL(10,7)
  longitude : DECIMAL(10,7)
  code_iris : VARCHAR(20)
  libelle_iris : VARCHAR(200)
  code_geographique_residence : VARCHAR(10)
  libelle_geographique_residence : VARCHAR(200)
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

TABLE(donnees_pmsi) {
  PK(pmsi_id) : BIGSERIAL
  FK(patient_id) : BIGINT
  --
  ' Core PMSI fields
  mode_sortie : VARCHAR(100)
  duree_sejour : INTEGER
  date_debut_sejour : DATE
  date_fin_sejour : DATE
  mode_entree : VARCHAR(100)
  statut_administratif : VARCHAR(50)
  --
  ' Healthcare facility information
  etablissement : VARCHAR(255)
  unite_fonctionnelle : VARCHAR(255)
  service : VARCHAR(255)
  --
  ' Geographic context at encounter time
  code_geographique_residence : VARCHAR(10)
  libelle_geographique_residence : VARCHAR(200)
  date_recueil : DATE
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

' =====================================================
' MEDICAL EVENTS AND PROCEDURES
' =====================================================

TABLE(diagnostics) {
  PK(diagnostic_id) : BIGSERIAL
  FK(pmsi_id) : BIGINT
  --
  ' Diagnostic information (linkId: 9391816419630)
  code_diagnostic : VARCHAR(20)
  type_diagnostic : VARCHAR(50)
  libelle_diagnostic : TEXT
  date_diagnostic : DATE
  sequence_diagnostic : INTEGER
  date_recueil : DATE
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

TABLE(actes) {
  PK(acte_id) : BIGSERIAL
  FK(pmsi_id) : BIGINT
  --
  ' Act/procedure information (linkId: 591926901726)
  code_acte : VARCHAR(20)
  libelle_acte : TEXT
  date_acte : TIMESTAMP
  executant : VARCHAR(255)
  sequence_acte : INTEGER
  date_recueil : DATE
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

' =====================================================
' CONSOLIDATED LABORATORY DATA
' =====================================================

TABLE(biologie) {
  PK(biologie_id) : BIGSERIAL
  FK(pmsi_id) : BIGINT
  FK(patient_id) : BIGINT
  --
  ' Test identification - consolidated biology table
  code_loinc : VARCHAR(20)
  libelle_test : VARCHAR(255)
  type_examen : VARCHAR(100)
  --
  ' Test results
  valeur : DECIMAL(15,6)
  unite : VARCHAR(50)
  valeur_texte : TEXT
  --
  ' Test context and timing
  date_prelevement : TIMESTAMP WITH TIME ZONE
  statut_validation : VARCHAR(50)
  --
  ' Reference ranges
  borne_inf_normale : DECIMAL(15,6)
  borne_sup_normale : DECIMAL(15,6)
  --
  ' Quality information
  commentaire : TEXT
  methode_analyse : VARCHAR(255)
  laboratoire : VARCHAR(255)
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

' =====================================================
' MEDICATION AND TREATMENT DATA
' =====================================================

TABLE(exposition_medicamenteuse) {
  PK(exposition_id) : BIGSERIAL
  FK(pmsi_id) : BIGINT
  FK(patient_id) : BIGINT
  --
  ' Medication identification (linkId: 817801935685)
  code_atc : VARCHAR(20)
  denomination : VARCHAR(255)
  forme_pharmaceutique : VARCHAR(100)
  voie_administration : VARCHAR(100)
  --
  ' Prescription context
  type_prescription : VARCHAR(50)
  prescripteur : VARCHAR(255)
  --
  ' Temporal information
  date_debut : DATE
  date_fin : DATE
  date_prescription : DATE
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

TABLE(posologie) {
  PK(posologie_id) : BIGSERIAL
  FK(exposition_id) : BIGINT
  FK(pmsi_id) : BIGINT
  FK(patient_id) : BIGINT
  --
  ' Posology details (linkId: 6348237104421)
  date_debut_prescription : DATE
  date_fin_prescription : DATE
  nombre_prises_par_jour : INTEGER
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

TABLE(dosage) {
  PK(dosage_id) : BIGSERIAL
  FK(exposition_id) : BIGINT
  FK(pmsi_id) : BIGINT
  FK(patient_id) : BIGINT
  --
  ' Dosage information (linkId: 5720103839343)
  quantite_administree : DECIMAL(10,3)
  unite_quantite : VARCHAR(20)
  date_heure_debut : TIMESTAMP
  date_heure_fin : TIMESTAMP
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

' =====================================================
' CLINICAL CARE AND LIFESTYLE DATA
' =====================================================

TABLE(dossier_soins) {
  PK(soins_id) : BIGSERIAL
  FK(pmsi_id) : BIGINT
  FK(patient_id) : BIGINT
  --
  ' Physical measurements (linkId: 305831246173)
  taille : DECIMAL(5,2)
  date_mesure_taille : DATE
  poids : DECIMAL(6,2)
  date_mesure_poids : DATE
  --
  ' Vital signs
  pression_systolique : DECIMAL(5,2)
  date_mesure_ps : DATE
  pression_diastolique : DECIMAL(5,2)
  date_mesure_pd : DATE
  --
  ' Measurement context
  type_mesure : VARCHAR(100)
  unite_soins : VARCHAR(255)
  professionnel : VARCHAR(255)
  commentaire : TEXT
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

TABLE(style_vie) {
  PK(style_vie_id) : BIGSERIAL
  FK(pmsi_id) : BIGINT
  FK(patient_id) : BIGINT
  --
  ' Lifestyle factors (linkId: 1693164086678)
  consommation_tabac : VARCHAR(100)
  consommation_alcool : VARCHAR(100)
  consommation_autres_drogues : VARCHAR(100)
  activite_physique : VARCHAR(100)
  date_recueil : DATE
  --
  ' Audit fields
  created_at : TIMESTAMP WITH TIME ZONE
  updated_at : TIMESTAMP WITH TIME ZONE
}

' =====================================================
' RELATIONSHIPS - Central Hub Architecture
' =====================================================

' Core patient-encounter relationship
patient ||--o{ donnees_pmsi : "patient_id"

' Medical events linked to encounters
donnees_pmsi ||--o{ diagnostics : "pmsi_id"
donnees_pmsi ||--o{ actes : "pmsi_id"

' Laboratory data - linked to both patient and encounter
patient ||--o{ biologie : "patient_id"
donnees_pmsi ||--o{ biologie : "pmsi_id"

' Medication exposure hierarchy
patient ||--o{ exposition_medicamenteuse : "patient_id"
donnees_pmsi ||--o{ exposition_medicamenteuse : "pmsi_id"

exposition_medicamenteuse ||--o{ posologie : "exposition_id"
exposition_medicamenteuse ||--o{ dosage : "exposition_id"

posologie }o--|| donnees_pmsi : "pmsi_id"
posologie }o--|| patient : "patient_id"

dosage }o--|| donnees_pmsi : "pmsi_id"
dosage }o--|| patient : "patient_id"

' Clinical care data
patient ||--o{ dossier_soins : "patient_id"
donnees_pmsi ||--o{ dossier_soins : "pmsi_id"

' Lifestyle data
patient ||--o{ style_vie : "patient_id"
donnees_pmsi ||--o{ style_vie : "pmsi_id"

@enduml